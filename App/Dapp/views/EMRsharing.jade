doctype html
html
  head
    title EMR-sharing Dashboard
    link(rel='stylesheet', href='stylesheets/EMRsharing.css')
  body
    header
      nav
        ul
          li.home
            a(href='/EMRsharing') EMR-sharing
          li.link(style='float:right')
            a(href='/createIdentity') Create Identity
          li.link(style='float:right')
            a(href='/login') EMR-sharing-login
          li.link(style='float:right')
            a(href='/userModule') User module
          li.link(style='float:right')
            a(href='/') DID-Dashboard
    main
      .dashboard
        .user-info-box
          h2.user-info-title User Information
          p#user-info-message Please Login First.
          .user-info-details
            p.user-info-item
              span.user-info-label UserId: 
              span#userID
            p.user-info-item
              span.user-info-label Role: 
              span#Role Patient/Doctor/Supervisor 
            button#ReloadButton(type='button') Reload Page
        - for (var i = 0; i < 5; i++)
          - if (i == 0)
              .container
                h2 AccessControl Instance Overview
                p The overview about your EMRsharing.
                pre#data
          - else if (i == 1)
              .container
                h2 Consent Access or Revoke Access
                p You can choose to Consent all level to access or only allow higher health-provider level to access
                button#consentButton(type='button') Consent
                button#revokeButton(type='button') Revoke
          - else if (i == 2)
              .container
                h2 Update instance or Update hash
                p Upload the new instance or the updated hash value
                p NEED TO LOGIN with "doctor" ROLE!!!
                label(for='hospitalIdInput') hospitalId:
                input#hospitalIdInput-1(type='text' name='hospitalIdInput-1' required='')
                br
                label(for='pointerInput') pointer:
                input#pointerInput(type='text' name='pointerInput' required='')
                br
                label(for='hashInput') hash:
                input#hashInput-1(type='text' name='hashInput-1' required='')
                br
                button#updateInsatnceButton(type='button') Update instance
                br
                br
                label(for='hospitalIdInput') hospitalId:
                input#hospitalIdInput-2(type='text' name='hospitalIdInput-2' required='')
                br
                label(for='hashInput') hash:
                input#hashInput-2(type='text' name='hashInput-2' required='')
                br
                button#updateHashButton(type='button') Update hash
          - else
              .container 
                h2 Container #{i+1}
                p This is some sample text for Container #{i+1}.
      
    script.
      async function getACL(uid) {
        try {
          const response = await fetch('/EMRsharing/getACL', {
            method: 'POST', // or 'GET', 'PUT', etc.
            headers: {
              'Content-Type': 'application/json',
              // 'Authorization': 'Bearer ' + token // if you use token-based authentication
            },
            body: JSON.stringify({
              userId: uid,
              // ...other data...
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json(); // parse the response as JSON
          // console.log('Success:', data);
          // Render the data within the if (i == 0) block
          if (data["result"]) {
            const dataElement = document.getElementById("data");
            dataElement.textContent = JSON.stringify(data["result"], null, 2);
          }
        } // try 
        catch (error) {
          console.error('Error:', error);
        } // catch
      } // getACL

      async function updateInstance(uid, _hospitalId, _pointer, _hash) {
        try {
          const response = await fetch('/EMRsharing/updateInstance', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              // 'Authorization': 'Bearer ' + token // if you use token-based authentication
            },
            body: JSON.stringify({
              userId: uid,
              hospitalId: _hospitalId,
              pointer: _pointer,
              hash: _hash
              // ...other data...
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json(); // parse the response as JSON
          console.log('Success:', data);
          alert(data["result"]["success"]);
        } // try 
        catch (error) {
          console.error('Error:', error);
        } // catch
      } // updateInstance()

      async function updateHash(uid, _hospitalId, _hash) {
        try {
          const response = await fetch('/EMRsharing/updateHash', {
            method: 'POST',
            headers: {
              'Content-Type': 'application/json',
              // 'Authorization': 'Bearer ' + token // if you use token-based authentication
            },
            body: JSON.stringify({
              userId: uid,
              hospitalId: _hospitalId,
              hash: _hash
              // ...other data...
            })
          });

          if (!response.ok) {
            throw new Error(`HTTP error! status: ${response.status}`);
          }

          const data = await response.json(); // parse the response as JSON
          console.log('Success:', data);
          alert(data["result"]["success"]);
        } // try 
        catch (error) {
          console.error('Error:', error);
        } // catch
      } // updateInstance()

      const userIdElement = document.getElementById("userID");
      const RoleElement = document.getElementById("Role");
      const userMessageElement = document.getElementById("user-info-message");
      const hospitalIdInput_1 = document.getElementById("hospitalIdInput-1");
      const pointerInput = document.getElementById("pointerInput");
      const hashInput_1 = document.getElementById("hashInput-1");
      const hospitalIdInput_2 = document.getElementById("hospitalIdInput-2");
      const hashInput_2 = document.getElementById("hashInput-2");

      document.addEventListener('DOMContentLoaded', function() {
        hospitalIdInput_1.value = "" ;
        pointerInput.value = "" ;
        hashInput_1.value = "" ; 
        hospitalIdInput_2.value = "" ;
        hashInput_2.value = "" ; 
      });

      ReloadButton.addEventListener("click", async function() {
        location.reload() ;
      });

      updateInsatnceButton.addEventListener("click", async function() {
        if ( !hospitalIdInput_1.value || !pointerInput.value || !hashInput_1.value )
          alert("Input the essential infomation first!!") ;
        else { 
          const hid = hospitalIdInput_1.value ;
          const pt = pointerInput.value ;
          const ha = hashInput_1.value ;
          updateInstance(userId, hid, pt, ha) ; 
          //- location.reload();
        } // else   
      }) ;

      updateHashButton.addEventListener("click", async function() {
        if ( !hospitalIdInput_2.value || !hashInput_2.value )
          alert("Input the essential infomation first!!") ;
        else 
          updateHash(userId, hospitalIdInput_2.value, hashInput_2.value) ;
      }) ;

      const queryParams = new URLSearchParams(window.location.search);
      // Get the values of the variables from the query parameters
      const userId = queryParams.get('userId');
      const role = queryParams.get('role');
      if (userId)
        userIdElement.textContent = userId ;
      if (role)
        RoleElement.textContent = role ;
      if (role && userId) {
        userMessageElement.textContent = "Please Enjoy!!" ;
        getACL(userId);
      } // if 

      
